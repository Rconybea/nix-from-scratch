# nxfs-execve-preload

Work around behavior of awk in isolated build.

Awk code like this:

```
#!/usr/bin/gawk -f

BEGIN {
    FS=";";
}

{
  command = "sort -r "
  print $1 | command
}
```

Awk `|` relies on glibc `popen()`, which in turn calls glibc `execve()` like:
```
execve("/bin/sh", "-c", "sort", ...)
```

Two reasons for this to fail in isolated build:
1. need absolute path to sort
2. /bin/sh not accessible from nix-build chroot

Address the first problem by rewriting awk scripts to use absolute store path:

```
{
  command = "/path/to/nix/store/sort -r"
  print $1 | command
}
```

To address the second problem we might try
rewriting glibc to prepend /path/to/nix/store/bash instead of /bin/sh

This is awkward during bootstrap.  We need to invoke `execve()` to build glibc,
so would need to do import-into-nex external-to-nix patched and kitbashed glibc.

Instead, build a shared library with a snowflake implementation of execve().
The snowflake version calls the 'real' `execve()`, but replaces `/bin/sh` in first
argument position with /path/to/nix/store/bash
