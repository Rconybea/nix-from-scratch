#include <unistd.h>
#include <string.h>
#include <dlfcn.h>

int (*_real_execve)(const char* path, char* const argv[], char* const envp[]) = NULL;

void __attribute__((constructor)) onload() {
    _real_execve = dlsym(RTLD_NEXT, "execve");
}

/* like original execve(), but substitute nix-store bash for /bin/sh.
 * Will preload this to modify behavior of chain {gawk '}'} -> popen -> execve
 */
int execve(const char* path, char* const argv[], char* const envp[])
{
    if (strcmp(path, "/bin/sh") == 0)
    {
        return (*_real_execve)("@bash_program@", argv, envp);
    } else {
        return (*_real_execve)(path, argv, envp);
    }
}
