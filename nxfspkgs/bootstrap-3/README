Introduction

Order is important here.  Builders progressively replace stage-2 packages with stage-3 versions.
Stage-3 versions are built from source within nix, using gcc+glibc also built from source within nix.

Recap:
- stage-0 imported external bootstrap ingredients into nix store as fixed-output derivations
- stage-1 prepared imported toolchain so that it's usable from withinc nix-build:
  it will have redirected stage-0 components so that libraries and dynamic linker
  refer to nix store versions. stage-1 uses vanilla nix derivations, relies entirely on patchelf.
- stage-2 compiled nix-native toolchain from stage-1 components.
  By the end of stage-2 all stage-1 executables have been superseded by nix-native versions;
  however stage-2 toolchain will in some places use at runtime stage-1 libraries.

In stage-3 we rebuild nix-native toolchain using stage-2 components.
Since everything is rebuilt with nix-native toolchain, we expect to arrive at a fixpoint.
Some stage-3 outputs still refer to stage-2 libraries. Binaries built by stage-3 toolchain will
refer only to stage-3

For packages in this directory, use nxfspkgs/default.nix

e.g.
  $ nix-build path/to/nix-from-scratch/nxfspkgs -A which-3
or
  $ export NIX_PATH=path/to/nix-from-scratch:${NIX_PATH}
  $ nix-build '<nxfspkgs>' -A which-3

----------------------------------------------------------------
Dependency Tower

Dependencies somewhat overspecified for the sake of simplicity.
(For example nxfs-curl-3 needs nxfs-gcc-wrapper-3, but not nxfs-gperf-3)

WWe need nxfs-xz-3, nxfs-bzip-3, nxfs-curl-3 for a stdenv.

 +---------------------------------------------------------------+
 |                        nxfs-fetchurl-3                        |
 +-------------------------+-----------------------+-------------+
 | -A xz-3   nxfs-xz-3     | -A curl-3 nxfs-curl-3 | -A cacert-3 |
 +-------------------------+-----------------------+             |
 | -A openssl-3       nxfs-openssl-3               | nxfs-cacert |
 +-------------------------------------------------+-------------+----------------------------------------+
 | -A stage3pkgs.gcc-wrapper-3                nxfs-gcc-x3-wrapper-3                                       |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gcc-x3-3                     nxfs-gcc-x3-3                                               |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gcc-x2-wrapper-3             nxfs-gcc-x2-wrapper-3                                       |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.libstdcxx-x2-3               nxfs-libstdcxx-x2-3                                         |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gcc-x1-wrapper-3             nxfs-gcc-x1-wrapper-3                                       |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gcc-x1-3                     nxfs-gcc-x1-3                                               |
 +------------------------------------------------------+-------------------------------------------------+
 | -A stage3pkgs.binutils-x0-wrapper-3                  | -A stage3pkgs.gcc-x0-wrapper-3                  |
 |                nxfs-binutils-x0-wrapper-3            |              nxfs-gcc-x0-wrapper-3              |
 +------------------------------------------------------+-------------------------------------------------+
 | -A stage3pkgs.glibc-x1-3                   nxfs-glibc-x1-3                                             |
 +-----------------+------------------------------------+---------------+---------------+-----------------+
 | -A stage3pkgs   | -A stage3pkgs                      | -A stage3pkgs | -A stage3pkgs | -A stage3pkgs   |
 |    .binutils-3  |    .texinfo-3                      |    .mpc-3     |    .python-3  |    .gzip-3      |
 |                 |         nxfs-texinfo-3             | nxfs-mpc-3    |               |                 |
 |                 +----------------b15-----------------+------d15------+               |     gzip/       |
 |                 | -A stage3pkgs   | -A stage3pkgs    | -A stage3pkgs |               |                 |
 |    binutils/    |    .automake-3  |    .bison-3      |    .mpfr-3    | nxfs-python-3 |                 |
 |                 |     automake/   | nxfs-bison-3     | nxfs-mpfr-3   |               |                 |
 |                 +--------b14------+------c14---------+------d14------+               | -A stage3pkgs   |
 |                 | -A stage3pkgs   | -A stage3pkgs    | -A stage3pkgs |               |    .gperf-3     |
 |                 |    .autoconf-3  |    .flex-3       |    .gmp-3     |               |                 |
 |                 |     autoconf/   | nxfs-flex-3      | nxfs-gmp-3    |               |     gperf/      |
 +-----------------+-----------------+---------------+--+------c13------+------d13------+                 |
 +--------------------------b13------+---------------|  -A stage3pkgs   | -A stage3pkgs |                 |
 | -A stage3pkgs   perl/             | -A stage3pkgs |     .file-3      |    .zlib-3    |                 |
 |    .perl-3                        |    .m4-3      |                  |               |                 |
 +-----------------------------------+               |                  |               | -A stage3pkgs   |
 | -A stage3pkgs   libxcrypt/        |               |                  |               |    .patchelf-3  |
 |    .libxcrypt-3                   |      m4/      |      file/       |     zlib/     |                 |
 +-----------------------------------+               |                  |               |    patchelf/    |
 | -A stage3pkgs   pkgconf/          |               |                  |               |                 |
 |    .pkgconf-3                     |               |                  |               |                 |
 +-----------------------------------+---------------+------------------+---------------+-----------------+
 | -A stage3pkgs.patch-3                      bootstrap-pkgs/patch                                        |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.coreutils-3                  bootstrap-pkgs/coreutils                                    |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gnumake-3                    bootstrap-pkgs/gnumake                                      |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gawk-3                       bootstrap-pkgs/gawk                                         |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.popen-3                      bootstrap-pkgs/popen                                        |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.popen-3                      bootstrap-pkgs/popen-template                               |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.bash-3                       bootstrap-pkgs/bash                                         |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gnutar-3                     bootstrap-pkgs/ncurses                                      |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gnutar-3                     bootstrap-pkgs/gnutar                                       |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.bzip2-3                      bootstrap-pkgs/bzip2                                        |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gnugrep-3                    bootstrap-pkgs/gnugrep                                      |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.gnused-3                     bootstrap-pkgs/gnused                                       |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.findutils-3                  bootstrap-pkgs/findutils                                    |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.diffutils-3                  bootstrap-pkgs/diffutils                                    |
 +--------------------------------------------------------------------------------------------------------+
 | -A stage3pkgs.which-3                      bootstrap-pkgs/which                                        |
 +--------------------------------------------------------------------------------------------------------+
 |                                            bootstrap-2                                                 |
 +--------------------------------------------------------------------------------------------------------+

nxfs-gcc-wrapper-2 gcc/g++ wrapper scripts to inject nix-store paths

NOTE:

1. nxfs-fetchurl-3 is a function, not a derivation; so can't be built directly.

2. Dependency nxfs-gnumake-2 <- nxfs-bash-2 is load-bearing.
The builtin $(shell ..) feature of gnumake would by default invoke /bin/sh.
That's true of the gnumake adopted into nix store from bootstrap/nxfs-gnumake-1.
We need to build a gnumake for which $(shell ..) invokes a nix-store-owned shell,
such as the one prepared by nxfs-bash-2.
ls

3. Dependency nxfs-gawk-3 <- nxfs-bash-3 is load-bearing.
The gawk i/o builtings are implemented by hardwiring calls like
  execl("/bin/sh", "sh", "-c", ...)
We need these to refer to nix-store-owned bash instead, for this to work from within
nix-build; at this point in bootstrap, substitute bash from nxfs-bash-3.

4. Dependency nxfs-gawk-3 <- nxfs-system-2 is vital.
nxfs-system-2 is source-only.  It contains a single function nxfs_system().
nxfs_system() is similar to glibc system(), except that it invokes nix-store-owned bash
from nxfs-bash-2, instead of /bin/sh.  nxfs-gawk-2 splices in this function to implement
the gawk system() builtin.  This is necessary for said builtin to work when invoked
in a chrooted nix-build,  in particular for building glibc.

DEBUGGING

see [nxfspkgs/build-support/make-derivation/make-derivation.nix for mkDerivation

see [nxfspkgs/build-support/make-stdenv/make-stdenv.nix for stdenv

see [nxfspkgs/build-support/autotools/default.nix]
for default derivation template.
template runs default-builder.sh (see below), which imports setup.sh (see below)

see [nxfspkgs/build-support/default-builder.sh]
for default builder.

see [nxfspkgs/build-support/autotools/setup.sh]
for default versions of bash functions used in default-builder:
  unpackPhase
  patchPhase
  configurePhase
  bulidPhase
  checkPhase
  installPhase
  fixupPhase
  installCheckPhase
  distPhase
  genericBuild
